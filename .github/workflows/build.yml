name: Build Package

on:
  workflow_dispatch:
    inputs:
      release:
        type: choice
        description: Release type
        options:
          - none
          - pre-release
          - release

env:
  SCCACHE_CACHE_SIZE: 9G
  SCCACHE_DIR: /home/runner/.cache/sccache

jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v3
          with:
            repository: google/bbr
            ref: v3
            path: bbr

        - name: Get latest stable kernel version
          id: kernel
          run: |
            LATEST_STABLE=$(curl -sSL https://www.kernel.org/releases.json | grep -oP '(?<="version": ")[^"]+' | head -1)
            echo "version=${LATEST_STABLE}" >> $GITHUB_OUTPUT
            echo "Latest stable kernel: ${LATEST_STABLE}"

        - name: Update to latest stable kernel
          working-directory: bbr
          run: |
            git fetch origin
            KERNEL_VERSION="${{ steps.kernel.outputs.version }}"
            # Try to find the closest stable tag or use the base v3 branch
            if git show-ref --quiet --verify "refs/tags/linux-${KERNEL_VERSION}"; then
              git checkout "linux-${KERNEL_VERSION}"
            else
              echo "Kernel version tag not found in BBR repo, using v3 branch with latest stable configs"
            fi

        - name: Get current time
          id: time
          run: echo "time=$(date -u "+%Y-%m-%d-%H%M%S")" >> $GITHUB_OUTPUT

        - name: Setup dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y build-essential \
              bc kmod cpio flex libncurses5-dev \
              libelf-dev libssl-dev dwarves bison \
              gawk openssl libssl-dev dkms libudev-dev \
              libpci-dev libiberty-dev autoconf debhelper
        
        - name: Set up Clang
          run: sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)" -- 19 all
        
        - name: Setup sccache
          uses: mozilla-actions/sccache-action@v0.0.4

        - name: Get .config
          run: curl -sSL https://raw.githubusercontent.com/Torinomii/bbr-v3-pkg/master/.config > bbr/.config
        
        - name: Update kernel config for stable version
          working-directory: bbr
          run: |
            # Generate a new config based on the current kernel version
            make LLVM=-19 olddefconfig > /dev/null 2>&1 || true

        - name: Setup cache
          uses: actions/cache@v4
          with:
            path: /home/runner/.cache/sccache
            key: sccache-${{ hashFiles('bbr/.config') }}-llvm19
        
        - name: Build
          working-directory: bbr
          env:
            KBUILD_BUILD_TIMESTAMP: ''
            KDEB_COMPRESS: "xz"
          run: |
            make \
              LLVM=-19 \
              LOCALVERSION="" \
              CC="sccache clang" \
              HOSTCC="sccache clang" \
              olddefconfig
            # Build deb
            make \
              LLVM=-19 \
              LOCALVERSION="" \
              CC="sccache clang" \
              HOSTCC="sccache clang" \
              -j`nproc` \
              bindeb-pkg
        
        - name: Upload config
          uses: actions/upload-artifact@v4
          with:
            name: config
            path: bbr/.config
        
        - name: Upload deb
          uses: actions/upload-artifact@v4
          with:
            name: deb
            path: linux-*.deb

        - name: Release
          if: ${{ github.event.inputs.release != 'none' }}
          uses: ncipollo/release-action@v1
          with:
            artifacts: "linux-*.deb"
            prerelease: ${{ github.event.inputs.release == 'pre-release' }}
            makeLatest: ${{ github.event.inputs.release == 'release' }}
            tag: ${{ steps.time.outputs.time }}

