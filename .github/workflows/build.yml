name: Build Package

on:
  workflow_dispatch:
    inputs:
      release:
        type: choice
        description: Release type
        options:
          - none
          - pre-release
          - release

permissions:
  contents: write

env:
  SCCACHE_CACHE_SIZE: 9G
  SCCACHE_DIR: /home/runner/.cache/sccache

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: google/bbr
          ref: v3
          path: bbr

      - name: Get current time
        id: time
        run: echo "time=$(date -u '+%Y-%m-%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Setup dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y build-essential \
            bc kmod cpio flex libncurses5-dev \
            libelf-dev libssl-dev dwarves bison \
            gawk openssl libssl-dev dkms libudev-dev \
            libpci-dev libiberty-dev autoconf debhelper

      - name: Set up Clang
        run: |
          set -euo pipefail
          sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)" -- 19 all

      - name: Get .config
        run: |
          set -euo pipefail
          curl -fSLS --retry 3 --retry-delay 3 https://raw.githubusercontent.com/Torinomii/bbr-v3-pkg/master/.config > bbr/.config

      - name: Update kernel config
        working-directory: bbr
        run: |
          set -euo pipefail
          make LLVM=-19 olddefconfig > /dev/null

      - name: Build
        working-directory: bbr
        env:
          KBUILD_BUILD_TIMESTAMP: ''
          KDEB_COMPRESS: "xz"
        run: |
          set -euo pipefail
          make \
            LLVM=-19 \
            LOCALVERSION="" \
            -j"$(nproc)" \
            bindeb-pkg

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: deb
          path: linux-*.deb

      - name: Release
        if: ${{ github.event.inputs.release != 'none' }}
        uses: ncipollo/release-action@v1
        with:
          artifacts: "linux-*.deb"
          prerelease: ${{ github.event.inputs.release == 'pre-release' }}
          makeLatest: ${{ github.event.inputs.release == 'release' }}
          tag: ${{ steps.time.outputs.time }}

